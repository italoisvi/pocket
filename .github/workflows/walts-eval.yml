name: Walts Agent Eval

on:
  # Nightly às 3:00 UTC (0:00 BRT)
  schedule:
    - cron: '0 3 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domínio específico (deixe vazio para todos)'
        required: false
        type: choice
        options:
          - ''
          - expenses
          - budgets
          - open_finance
          - analysis
          - categorization
          - goals
          - recurring
          - reports
      run_group:
        description: 'Nome do run group'
        required: false
        default: 'manual'

  # Em PRs que alterem o agente
  pull_request:
    paths:
      - 'supabase/functions/walts-agent/**'
      - 'supabase/functions/walts-eval-runner/**'
      - 'supabase/seeds/eval-cases.sql'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  EVAL_TEST_USER_ID: ${{ secrets.EVAL_TEST_USER_ID }}

jobs:
  eval:
    name: Run Walts Evals
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "$SUPABASE_URL" ]; then
            echo "::error::SUPABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "::error::SUPABASE_SERVICE_ROLE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$EVAL_TEST_USER_ID" ]; then
            echo "::error::EVAL_TEST_USER_ID secret is not set"
            exit 1
          fi
          echo "All secrets are configured"

      - name: Generate run group name
        id: run_group
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "name=nightly-$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "name=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.run_group }}" ]; then
            echo "name=${{ inputs.run_group }}-$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT
          else
            echo "name=manual-$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT
          fi

      - name: Run eval-runner
        id: eval
        run: |
          # Build request body
          BODY="{\"test_user_id\": \"$EVAL_TEST_USER_ID\", \"run_group\": \"${{ steps.run_group.outputs.name }}\""

          # Add domain filter if specified
          if [ -n "${{ inputs.domain }}" ]; then
            BODY="${BODY}, \"domain\": \"${{ inputs.domain }}\""
          fi

          BODY="${BODY}}"

          echo "Request body: $BODY"

          # Call eval-runner
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/walts-eval-runner" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          # Extract HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          # Save response for later steps
          echo "$BODY" > eval_results.json

          # Check for errors
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Eval runner returned HTTP $HTTP_CODE"
            exit 1
          fi

          # Extract summary
          TOTAL=$(echo "$BODY" | jq -r '.total_cases // 0')
          PASSED=$(echo "$BODY" | jq -r '.passed // 0')
          FAILED=$(echo "$BODY" | jq -r '.failed // 0')
          PASS_RATE=$(echo "$BODY" | jq -r '.pass_rate // 0')
          AVG_SCORE=$(echo "$BODY" | jq -r '.avg_score // 0')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
          echo "avg_score=$AVG_SCORE" >> $GITHUB_OUTPUT

          echo "## Eval Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Cases | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| Pass Rate | ${PASS_RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg Score | $AVG_SCORE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run Group: \`${{ steps.run_group.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Check pass rate threshold
        run: |
          PASS_RATE=${{ steps.eval.outputs.pass_rate }}
          THRESHOLD=80

          echo "Pass rate: ${PASS_RATE}%"
          echo "Threshold: ${THRESHOLD}%"

          # Use bc for floating point comparison
          if (( $(echo "$PASS_RATE < $THRESHOLD" | bc -l) )); then
            echo "::error::Pass rate ${PASS_RATE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

          echo "Pass rate is acceptable"

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eval-results-${{ steps.run_group.outputs.name }}
          path: eval_results.json
          retention-days: 30

      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('eval_results.json', 'utf8'));

            const passEmoji = results.pass_rate >= 80 ? '✅' : '❌';
            const failedCases = results.results
              .filter(r => !r.pass)
              .map(r => `- \`${r.case_name}\` (${r.domain})${r.error ? ': ' + r.error : ''}`)
              .join('\n');

            const body = `## ${passEmoji} Walts Eval Results

            | Metric | Value |
            |--------|-------|
            | Total Cases | ${results.total_cases} |
            | Passed | ${results.passed} |
            | Failed | ${results.failed} |
            | Pass Rate | ${results.pass_rate.toFixed(1)}% |
            | Avg Score | ${results.avg_score.toFixed(2)} |

            ${results.failed > 0 ? `### Failed Cases\n${failedCases}` : ''}

            <details>
            <summary>Run Details</summary>

            - Run Group: \`${results.run_group}\`
            - Triggered by: ${context.actor}
            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: eval
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Send failure notification
        run: |
          echo "::warning::Nightly eval failed! Check the workflow run for details."
          # Adicione aqui integração com Slack/Discord/Email se desejar
          # Exemplo Slack:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"⚠️ Walts nightly eval failed!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
